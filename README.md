# LuaAndroidTest
Test project to reproduce differences in results of project anarchy scripting on Win32 and Android build

Setup: run the RUN_ONCE.bat to install the `\Data` folder from your Project Anarchy installation.

# Test Scene Expected Behavior
1. The scene should spawn 3 cubes in the middle of the scene every 1.0 seconds from a prefab.
1. The cube has a physics body and should move up a little then fall to the floor.
1. The cubes will be removed after they have been alive for 1.8 seconds

# Behavior on Android (Tested on x86 and Arm build)
Most of the time, less than 3 entities will appear spawn.
The longer the build is run for, the less entities will spawn.
It appears that they are spawning and being removed instantly.

# Behvior in vForge
As expected.

# Possible cause
Each entity defines a "self.age" value, if that value is nil then it sets it to zero and uses it to keep track of how long it has been alive.

It seems that the self.age value is not nil when a new object is created, possibly it has the value of a previous instance.

# Notable Files 
[SceneScript.lua](Assets/Scripts/SceneScript.lua) - spawns the cubes

[EntityScript.lua](Assets/Scripts/EntityScript.lua) - script for each entity that is spawned that handles removal of itself

# Other notes & Investigation

This build contains no custom swig wrappers, or any custom C++ code. The project code was generated by PA 2014.1

# Logging OnObjectDeleted Callback

I added the following log line to VScriptResourceManager::OnHandleCallback, to log when the lua wrapper is removed

	void VScriptResourceManager::OnHandleCallback(IVisCallbackDataObject_cl *pData)
	{
		...
		
	  if (pData->m_pSender == &VTypedObject::OnObjectDeleted)
	  {
	    VTypedObjectCallbackData* pTypedObjectData = static_cast<VTypedObjectCallbackData*>(pData);
	    LUA_RemoveWrapperFromLookupTable(m_pMasterState, pTypedObjectData->m_pObject);
			hkvLog::Info( "VTypedObject::OnObjectDeleted %p", pTypedObjectData->m_pObject);	//logging the pointer to the object that was deleted
	  }
	}

**Win32 Log...**

The Win32 build shows 3 log lines from the lua script and seems to consistently delete 6 objects after every frame (once deletions had started)

	1.8086=self.age, 80=self.numThinks at removal time
	1.8086=self.age, 80=self.numThinks at removal time
	1.8086=self.age, 80=self.numThinks at removal time
	VTypedObject::OnObjectDeleted 1A50BA10
	VTypedObject::OnObjectDeleted 1A3A35B8
	VTypedObject::OnObjectDeleted 1A509A08
	VTypedObject::OnObjectDeleted 1A3A4300
	VTypedObject::OnObjectDeleted 1A50A070
	VTypedObject::OnObjectDeleted 1A3A3DB0
	1.81883=self.age, 95=self.numThinks at removal time
	1.81883=self.age, 95=self.numThinks at removal time
	1.81883=self.age, 95=self.numThinks at removal time
	VTypedObject::OnObjectDeleted 1A509778
	VTypedObject::OnObjectDeleted 1A3A2B18
	VTypedObject::OnObjectDeleted 1A50BB58
	VTypedObject::OnObjectDeleted 1A3A2078
	VTypedObject::OnObjectDeleted 1A5098C0
	VTypedObject::OnObjectDeleted 1A3A45A8

**Android x86 log...**

There was no evidence of the OnObjectDeleted callback happening on Android, even after running for some time.
Notice, that the value of self.numThinks is also very high in some cases, showing that the old wrappers are being reused on new objects.

	02-11 14:48:21.301: W/printf(29694): 1.81998=self.age, 81=self.numThinks at removal time
	02-11 14:48:22.271: W/printf(29694): 1.80015=self.age, 161=self.numThinks at removal time
	02-11 14:48:22.271: W/printf(29694): 1.80015=self.age, 161=self.numThinks at removal time
	02-11 14:48:22.291: W/printf(29694): 1.82254=self.age, 323=self.numThinks at removal time
	02-11 14:48:23.291: W/printf(29694): 1.80849=self.age, 242=self.numThinks at removal time
	02-11 14:48:23.291: W/printf(29694): 1.80843=self.age, 161=self.numThinks at removal time
	02-11 14:48:23.291: W/printf(29694): 1.8084=self.age, 881=self.numThinks at removal time
	02-11 14:48:24.311: W/printf(29694): 1.81163=self.age, 666=self.numThinks at removal time
	02-11 14:48:24.311: W/printf(29694): 1.81201=self.age, 241=self.numThinks at removal time
	02-11 14:48:24.311: W/printf(29694): 1.81201=self.age, 241=self.numThinks at removal time
	02-11 14:48:25.331: W/printf(29694): 1.8056=self.age, 403=self.numThinks at removal time
	02-11 14:48:25.331: W/printf(29694): 1.80587=self.age, 322=self.numThinks at removal time
	02-11 14:48:25.331: W/printf(29694): 1.80587=self.age, 241=self.numThinks at removal time
	02-11 14:48:26.371: W/printf(29694): 1.80833=self.age, 80=self.numThinks at removal time
	02-11 14:48:26.371: W/printf(29694): 1.80833=self.age, 80=self.numThinks at removal time
	02-11 14:48:26.371: W/printf(29694): 1.80833=self.age, 80=self.numThinks at removal time
	02-11 14:48:27.361: W/printf(29694): 1.80482=self.age, 746=self.numThinks at removal time
	02-11 14:48:27.361: W/printf(29694): 1.80482=self.age, 321=self.numThinks at removal time





